<meta charset="utf-8" emacsmode="-*- markdown -*-"><link rel="stylesheet" href="./slate.css">

**Verifying Symbol account state proofs (part 2)**

[Previous part](2021-06-17-account.state.part1.html) analyzed how account states are serialized in Symbol blockchain and how the state can be verified using merkle tree path. The account in part 1 was simple account, in this part I’m going to walk you through slightly more complicated example.

!!!
    images will be zoomed in when clicked (opens in new tab/window)

# Serializing state

This time account of interest will be `TCIAR4BDWLX22WGIHU3OQSJKUOAJZTP6HO2XLQI`. This is second richest account in testnet as of now. It’s visible on explorer screenshot below, that it has enormous importance of 29%.

![`TCIAR4BDWLX22WGIHU3OQSJKUOAJZTP6HO2XLQI` account details as seen in block explorer](2021-06-30-account.state.part2/01-explorer.png width=600)

Querying `/accounts/TCIAR4BDWLX22WGIHU3OQSJKUOAJZTP6HO2XLQI`, yields following data:

```json
{
  "account": {
    "version": 1,
    "address": "989008F023B2EFAD58C83D36E8492AA3809CCDFE3BB575C1",
    "addressHeight": "1",
    "publicKey": "D1A549D23F22C912169105C4A57AC82D82BC07B1F7F1AA092B14E03B8E2DDCF9",
    "publicKeyHeight": "30818",
    "accountType": 0,
    "supplementalPublicKeys": {},
    "activityBuckets": [
      { "startHeight": "206820", "totalFeesPaid": "0", "beneficiaryCount": 0, "rawScore": "2331691338220390" },
      { "startHeight": "206640", "totalFeesPaid": "0", "beneficiaryCount": 0, "rawScore": "2331698263781336" },
      { "startHeight": "206460", "totalFeesPaid": "0", "beneficiaryCount": 0, "rawScore": "2331707744132286" },
      { "startHeight": "206280", "totalFeesPaid": "0", "beneficiaryCount": 0, "rawScore": "2331717124895476" },
      { "startHeight": "206100", "totalFeesPaid": "0", "beneficiaryCount": 0, "rawScore": "2331724850931849" }
    ],
    "mosaics": [
      { "id": "091F837E059AE13C", "amount": "2465300037570560" }
    ],
    "importance": "2331691338220390",
    "importanceHeight": "206820"
  },
  "id": "<node-based, not important>"
}
```

This account clearly has non-zero importance, which means account serialization from previous part will require some fixes.

![python code for serializing account state](2021-06-30-account.state.part2/02-serialize.png width=600)

Serialized account state is bit longer and looks like following (split into chunks for readability, marked lines are related to importance):

```
  0100
  989008f023b2efad58c83d36e8492aa3809ccdfe3bb575c1
  0100000000000000
  d1a549d23f22c912169105c4a57ac82d82bc07b1f7f1aa092b14e03b8e2ddcf9
  6278000000000000
  00
+ 01
  00
  00
+ 66c3f031a9480800
+ e427030000000000
+ e427030000000000 0000000000000000 00000000 66c3f031a9480800
+ 3027030000000000 0000000000000000 00000000 d86fbcceaa480800
+ 7c26030000000000 0000000000000000 00000000 be1ccf03ad480800
+ c825030000000000 0000000000000000 00000000 f432f232af480800
+ 1425030000000000 0000000000000000 00000000 892874ffb0480800
  0100
  3ce19a057e831f09 001001652dc20800
```

And resulting account state sha3 hash is `5bef848aa6adf5825f01a2aac836dccaf1f00cbca8440d1d49bb335e2068ba36`

# Verifying state tree

Current (at the time of writing) merkle tree path looks like this:

![merkle path of account TCIAR4BDWLX22WGIHU3OQSJKUOAJZTP6HO2XLQI](2021-06-30-account.state.part2/03-merkle1.png width=600)

It’s instantly clear, that calculated account state hash, matches value of a leaf (below):

```json
{
  "type": 255,
  "path": "41DE874FE84AA7F3ED022A73F6F6762C439A45C15A7BA9F1A9F075E93690",
  "encodedPath": "341DE874FE84AA7F3ED022A73F6F6762C439A45C15A7BA9F1A9F075E9369",
  "nibbleCount": 59,
  "value": "5BEF848AA6ADF5825F01A2AAC836DCCAF1F00CBCA8440D1D49BB335E2068BA36",
  "leafHash": "DCE07E21C58F85B79F1F588637FB39CE024D23A885CEF7868879D69B83B9E5B0"
}
```

Path of the account is: `4D25C41DE874FE84AA7F3ED022A73F6F6762C439A45C15A7BA9F1A9F075E9369` ([verify here](https://bob.nem.ninja/sha3/#989008f023b2efad58c83d36e8492aa3809ccdfe3bb575c1)),
path fragments leading to leaf are `4`, `D`, `2`, `5`, `C`
I will not describe in details how to verify whole path, as it is the process is the same as in previous part, I’m only providing links to verify calculations at subsequent levels:

 * [leaf hash](https://bob.nem.ninja/sha3/#341DE874FE84AA7F3ED022A73F6F6762C439A45C15A7BA9F1A9F075E9369%0A5BEF848AA6ADF5825F01A2AAC836DCCAF1F00CBCA8440D1D49BB335E2068BA36)
 * [level 5](https://bob.nem.ninja/sha3/#00%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A2687882B14F6A90FAF764E461098013855A7E73047B18C9A91E2C543741273AE%0A0000000000000000000000000000000000000000000000000000000000000000%0ADCE07E21C58F85B79F1F588637FB39CE024D23A885CEF7868879D69B83B9E5B0%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000)
 * [level 4](https://bob.nem.ninja/sha3/#00%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0994E85AF3D37B841EC2F9390FC40A10DF4242D19E1268A114202D709E36E1A0%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0AE2D2226C95D9B5DD4A9111A297208DD4C14453A2F31362FF1B882AC620BA798A%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A0000000000000000000000000000000000000000000000000000000000000000%0A36E1B20BDB20EE92C36004621D0B188F6C64E03CBD758FECE16D2B0C444AB9C5%0A0000000000000000000000000000000000000000000000000000000000000000)
 * [level 3](https://bob.nem.ninja/sha3/#00%0ABD4685989FFEB35AFEA27ABFDCBE2A3CFCC6E2FF56B77118D4D5B86534584913%0AE3224280AD27BCA70E217B347C1743F21658F9F85D644C1A649EA4DE150900E5%0A5E3776025723AFD484805D7014D6F13B38289F3BD6DC9839E7B4EA05370A38DB%0A6FCC39B4D2A3513210EAFE66E081388F9496B0E1430AAA42E5B9647B8ECACD03%0AC5304DE707773D3C23C607AE42D254100D2F8E16E9E1EFC5163A74E22B84AC64%0AB51F65FF9DADCF0E8FEAD5053C0A2CD461DFC6758847173CFF919F37407E80EC%0A410103F4E0C1D0349201948DB056999835D6B3228EB31832F03BEA413426CEDD%0A6095FCA0EE3FC0CAF94A933B0EDDAD45A1DA4C06823BE1B9AF2AFC1732D4A912%0A39346E3BFFE8DD9B6A215C2E7D28DD3730A839BE93E60413398E4A6F28E015AA%0A96002ECAC43501313413BE42F5644E3C7853A2E62DD6B684ECACB9B3065464CC%0A335127F2DC8826C82F0D2AC4918E9C256C9A2B01FE54D09D6486DDD2EA2ECDBF%0A0545487F04FC1208516E8F9F31E54FE1B44145D89234522DEEEEA76591DCC9D2%0AE9B6A2D84607B4CEEB3214E55AE283E15EB39774BED294D6F8596AF45687B28F%0AEC67C68B1871A996B55068F5B637F4812E73F473936DE0107A429F5C15D6B0A5%0A13820D99934C9A48FE9BF3E7C16963B9E6EF5291298200B4CDA2D874D7878FBC%0A5AB9DE7C898D15CB88EC7C3FD5D574715DD14A4E9DCAD0C69A7ED973CFFB551C)
 * [level 2](https://bob.nem.ninja/sha3/#00%0A65A6BD7863AD4E4E809EE59D99E077F3BD2DBA60D9D9E027E2C316DF03E091B0%0A601B573951048FA465E02688270C26C37BE8F3F4359860D04FA8A071F6588129%0AFEFF294904E54B56B574A62005876C54ED625EF51016766E873E0654D8C2D660%0AE74F3D2C45408079939F00C0BCA6E80F824DBA2EA199130170376D9BF8D25306%0A152AB9E1B97067A5961D310673367F460C7084F359E12996252C06D3CDD5DF89%0AA6A74392340C7E538DE243594CADF75185CF688C10924BFD4E826D38799503B4%0A8CB8A6044E0AA4B2B5307AA5C950D9BDD92A5A0DE76E433CD512FD1431FF3111%0AC2C78CA54E2A52F6694DBB0D8D10DDAE4D996B196F45AE4F8492669C2052B5B7%0A14E35CDCF4316C7044FF11302D86393E3407EE8FAA962C57DA766F75F2FA79A3%0AD2A4E038E5ACE1FEAD48CAA9B16E35E7B71C53B088FC644AD35F72A6258BCCC7%0AD97B75608690173986EF46C160BF7DDDB9C74ADD1D8E8C20D68D3307B2FE8993%0AA12A7D117D4DA01E89B7DFC32804DA94DD3A6C4F039037BCD6982A462DC49D0C%0A8CAC51CCBB1A5AB6E00D6AAA5D0B2F05F70ADF92F4D9DFEB5DDF2692F0DCBA92%0A84996D733C7C780104CD8FEF2C12C498940EA1EB3EF51E5BD61446CDD97BADC4%0A79E416695E23FF11547B4FC2549E726F19E2F7B8C9E823D732AA902DFBA41398%0AF2B2C717D843D5AEF8CBC885F2439E685432B530DBE2079718A8C05BFD3D2BCE)
 * [root level (1)](https://bob.nem.ninja/sha3/#00%0A5A83CC6F1AA7A7C183EFF80A79F3C3C1F68DEA5D4C65B16D322E16D5E5BD1135%0A070D55F6C58304B41520B7B085CF7BDA76DC52433F1EF1B1FB311EF6D749AB03%0A76E606C525B31B02B92C5AAFF86312FA758A5FCF0A6DB3D609EC22FA391CEB0B%0A68927C71C6ED2DF82D5C8F3340CA760CE0AFFF19DFE8E403819F1705C0FEABAD%0AE820E01837E142BC0C3AB2DB112BAAF8B3F114511602F42B755B8ED60596E4D0%0AC73117E6E40164B1C224D264D49D062C5ABE495651DE46B0162583EB9651DB71%0A85F606C5C47A2C0B2E6710514452EAF992B854CA77A81BA7384C0FC2127ABFB1%0A781AA36FE6CD6D13D400F4F2559E583D07D5F98DC3884076BA77DFF396750D5D%0A6F733BCE6EA123CDBD5988D82680A41C32A925F646F6AA727B31841D71F19D94%0A03D8CEA77573E81CA0E774631DE60A90218360E0BF2B829315293B5E3C409183%0A2CB9EBECCC04E5BD155A4A19F63C485ED50F870B02C83D705EEDA497BAD0E437%0ACB22B1F94A789C8292A6F9053CB526BD0E7A018ED1BE6509BCF5401A2F7B3478%0A331298B52661BF6FA45781BF95B7FA4EFAB6CD4CEF57F289597ADB7F8B7D39D6%0A2C71C6D58F2EC11645E385A8FA6B475AC7E9A4A5987A1D2E8609B693541AA5B0%0A7A49F7BA135000789E557991FF10A2E4C7CDC856E193E4994D65F849FE652269%0A272174607F2E8FC3503E51167682E5D65FE3B04D978012F547BDEED5CACBC485)

Calculated root level hash is `7CEEF324D7817C6C58DFE0A04D1318B13BD3773CC5BCFE00BC48D6A12F135025`

That matches account state root hash in block http://explorer.testnet.symboldev.network/blocks/206834

![Block explorer information for block at height 206834](2021-06-30-account.state.part2/04-explorer.block.png width=600)

# Missing pieces

There are some information that have not been presented in this or previous part:

 * serialization of keys (remote, node, vrf and voting keys), but this is quite straightforward
 * how non-empty paths inside branches are treated; there’s a low chance of this happening naturally — that is explained in more details in whitepaper, in short, encoded path part (of a branch) is first element that is hashed

<style class="fallback">body{visibility:hidden}</style><script>markdeepOptions={tocStyle:'long'};</script>
<!-- Markdeep: --><script src="./markdeep.min.js" charset="utf-8"></script>

